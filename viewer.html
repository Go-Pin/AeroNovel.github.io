<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <META HTTP-EQUIV="pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
    <META HTTP-EQUIV="expires" CONTENT="0">
    <title>Aero Novel</title>
    <style>
        body {
            background: antiquewhite;
        }

        #main {
            line-height: 1.7;
            width: 96%;
            margin: 2%;
            font-size: 20px;
            font-family: "宋体";

        }

        #main>p {
            margin: 0;
            text-indent: 2em;
        }

        #main>.drawout {
            margin: 0;
            text-indent: 1.2em;
        }

        .note {
            color: cornflowerblue;
        }

        #main>.aligned {
            text-indent:0;
        }
    </style>
</head>

<body>
    <p id="log"></p>
    <div id="main"></div>
    <script type="text/javascript">
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return decodeURIComponent(r[2]); return null;
        }
        var title = GetQueryString("t");
        var n = GetQueryString("n");
        var log = document.getElementById("log");
        var main = document.getElementById("main");
        log.innerHTML += "Title:" + title + ";";
        var key=title+"_"+n;
        var TOC;
        var loader;
        var ok=false;
        Load();//Load->RenderTOC->LoadContent->RenderContent
        function RenderTOC() {
            if (loader.readyState == 4)
                if (loader.status == 200) {
                    TOC = loader.responseText.split("\n");
                    LoadContent();
                }
        }
        function Load() {
            //Load TOC
            loader = new XMLHttpRequest();
            loader.open('GET', 'Novels/' + title + '/contents.txt', true);
            loader.onreadystatechange = RenderTOC;
            loader.send(null);
        }
        function RenderContent() {
            if (loader.readyState == 4)
                if (loader.status == 200) {
                    var cont = loader.responseText.split("\n");
                    var code = "";
                    var line = 0;
                    cont.forEach(ele => {
                        var c = ele.replace('\r', '');
                        c = EncodeNovel(c);
                        var cla = "";
                        if (c.length == 0) c = "<br>";
                        if (c[0] == "「" || c[0] == "『" || c[0] == "（") cla += " drawout";
                        code += "<p id='line" + line + "' class='" + cla + "'>" + c + "</p>";
                        line++;
                    });
                    main.innerHTML = code;
                    var ua = navigator.userAgent;
                    var iPad = ua.match(/(iPad).*OS\s([\d_]+)/),
                        iPhone = !iPad && ua.match(/(iPhone\sOS)\s([\d_]+)/),
                        isAndroid = ua.match(/(Android)\s+([\d.]+)/),
                        isMobile = iPhone || isAndroid;
                    if (isMobile) {
                        log.innerHTML += "Mobile;";
                        main.style.fontSize = "5vw";
                    }
                    var fir = main.getElementsByTagName("p")[0];
                    fir.style.fontWeight = "bold";
                    fir.style.fontSize = "1.5em";
                    fir.style.textIndent = "0";
                    fir.style.textAlign = "center";
                    document.documentElement.scrollTop=localStorage.getItem(key);
                    ok=true;
                }
        }
        function LoadContent() {
            TOC.forEach(ele => {
                if (ele.indexOf(n) == 0) {
                    loader = new XMLHttpRequest();
                    loader.open('GET', 'Novels/' + title + "/" + ele, true);
                    loader.onreadystatechange = RenderContent;
                    loader.send(null);
                    return;
                }
            });


        }
        var note_count = 0;
        var notes = new Array();
        function EncodeNovel(c) {
            var reg = /\[(.*?)\]/gi;
            var r = c;
            while (true) {
                var match = reg.exec(r);
                if (match == null) break;
                console.log(match[1]);
                switch (match[1]) {
                    case "note":
                        r = r.replace(match[0], "<a class='note' onclick='Footnote(" + note_count + ")'><sup>注</sup></a>");
                        note_count++;
                        break;
                    case "/align":
                        r = r.replace(match[0], "</p>");
                        break;
                    default:
                        var spl = match[1].split("=");
                        if (spl.length == 2) {
                            switch (spl[0]) {
                                case "align":
                                    r = r.replace(match[0], "<p class='aligned' style='text-align:" + spl[1] + "'>");
                                    break;
                            }
                            break;
                        }
                        r = r.replace(match[0], "");
                        notes.push(match[1]);
                        break;
                }
            }
            return r;
        }
        function Footnote(a) {
            alert(notes[a]);
        }

        setInterval(SavePos,5000);
        function SavePos()
        {
            if(ok)localStorage.setItem(key,document.documentElement.scrollTop); 
        }
       
    </script>
</body>

</html>