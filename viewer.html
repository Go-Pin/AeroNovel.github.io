<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-control" content="no-cache">
    <title>Aero Novel</title>
    <style>
        body{background: antiquewhite;}
        #main {
            line-height: 1.7;
            width: 96%;
            margin: 2%;
            font-size: 20px;
            
        }

        #main>p {
            margin: 0;
            text-indent: 2em;
        }

        #main>.drawout {
            margin: 0;
            text-indent: 1.2em;
        }
    </style>
</head>

<body>
    <p id="log"></p>
    <div id="main"></div>
    <script type="text/javascript">
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return decodeURIComponent(r[2]); return null;
        }
        var title = GetQueryString("t");
        var n = GetQueryString("n");
        var log = document.getElementById("log");
        var main = document.getElementById("main");
        log.innerHTML += "Title:"+title+";";
        var TOC;
        var loader;
        Load();//Load->RenderTOC->LoadContent->RenderContent
        function RenderTOC() {
            if (loader.readyState == 4)
                if (loader.status == 200) {
                    TOC = loader.responseText.split("\n");
                    LoadContent();
                }
        }
        function Load() {
            //Load TOC
            loader = new XMLHttpRequest();
            loader.open('GET', 'Novels/' + title + '/contents.txt', true);
            loader.onreadystatechange = RenderTOC;
            loader.send(null);
        }
        function RenderContent() {
            if (loader.readyState == 4)
                if (loader.status == 200) {
                    var cont = loader.responseText.split("\n");
                    var code = "";
                    cont.forEach(ele => {
                        var c = ele.replace('\r','');
                        c=EncodeNovel(c);
                        var cla = "";
                        if (c.length == 0) c = "<br>";
                        if (c[0] == "「" || c[0] == "『" || c[0] == "（") cla += " drawout";
                        code += "<p class='" + cla + "'>" + c + "</p>";
                    });
                    main.innerHTML = code;
                    var ua = navigator.userAgent;
                    var iPad = ua.match(/(iPad).*OS\s([\d_]+)/),
                        iPhone = !iPad && ua.match(/(iPhone\sOS)\s([\d_]+)/),
                        isAndroid = ua.match(/(Android)\s+([\d.]+)/),
                        isMobile = iPhone || isAndroid;
                    if (isMobile) {
                        log.innerHTML+="Mobile;";
                        main.style.fontSize = "5vw";              
                    }
                    var fir=main.getElementsByTagName("p")[0];
                    fir.style.fontWeight="bold";
                    fir.style.fontSize="1.5em";
                    fir.style.textIndent="0";
                    fir.style.textAlign="center";
                }
        }
        function LoadContent() {
            TOC.forEach(ele => {
                if (ele.indexOf(n) == 0) {
                    loader = new XMLHttpRequest();
                    loader.open('GET', 'Novels/' + title + "/" + ele, true);
                    loader.onreadystatechange = RenderContent;
                    loader.send(null);
                    return;
                }
            });


        }
        var note_count=0;
        var notes=new Array();
        function EncodeNovel(c)
        {
            var pos=0;
            var reg=/\[(.*?)\]/gi;
            while(pos<c.length)
            {
                var match=reg.exec(c,pos);
                if(match!=null)
                switch(match[1])
                {
                    case "note":
                    c=c.replace(match[0],"<sup ontouchstart='Footnote("+note_count+")'>[注]</sup>");
                    note_count++;
                    break;
                    default:
                    c=c.replace(match[0],"");
                    notes.push(match[1]);
                    ;
                }
                pos=match.lastIndex;
            }
            return c;
        }
        function Footnote(a)
        {
            alert(notes(a));
        }
    </script>
</body>

</html>